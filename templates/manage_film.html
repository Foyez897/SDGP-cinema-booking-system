<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Films & Showtimes</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { display: flex; flex-direction: column; min-height: 100vh; }
    main { flex: 1; }
    td, th { text-align: center; vertical-align: middle; }
    .cell-clickable { cursor: pointer; }
    .dropdown-item:hover { background-color: #f8f9fa; }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="/">üé¨ Horizon Cinemas</a>
    <a href="/admin_dashboard" class="btn btn-outline-light">Dashboard</a>
  </div>
</nav>

<main class="container mt-4">

  <h2 class="text-center mb-4">üéûÔ∏è Manage Films & Showtimes - ({{ selected_cinema_info.location }})</h2>

  <!-- üîç Filters -->
  <form class="row g-2 mb-4" method="GET">
    <input type="hidden" name="cinema_id" value="{{ selected_cinema }}">
    <div class="col-md-4">
      <label>Filter by Date:</label>
      <input type="date" class="form-control" name="date" value="{{ selected_date }}" onchange="this.form.submit()">
    </div>
    <div class="col-md-4">
      <label>Filter by Film:</label>
      <select class="form-select" name="film_id" onchange="this.form.submit()">
        <option value="">-- All Films --</option>
        {% for f in films %}
          <option value="{{ f.id }}" {% if f.id|string == selected_film_id %}selected{% endif %}>{{ f.title }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label>Filter by Screen:</label>
      <select class="form-select" name="screen_number" onchange="this.form.submit()">
        <option value="">-- All Screens --</option>
        {% for s in screens %}
          <option value="{{ s }}" {% if s|string == selected_screen %}selected{% endif %}>Screen {{ s }}</option>
        {% endfor %}
      </select>
    </div>
  </form>

  <!-- üìã Film Table -->
  <h4>üé¨ Film Listings</h4>
  <table class="table table-striped table-hover mb-4">
    <thead>
      <tr>
        <th>Title</th><th>Genre</th><th>Age Rating</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for film in films %}
        <tr>
          <form action="{{ url_for('admin.update_film', film_id=film.id) }}" method="POST">
            <td><input name="title" value="{{ film.title }}" class="form-control"></td>
            <td><input name="genre" value="{{ film.genre }}" class="form-control"></td>
            <td><input name="age_rating" value="{{ film.age_rating }}" class="form-control"></td>
            <td>
              <button class="btn btn-sm btn-success">Save</button>
              <a href="{{ url_for('admin.delete_film', film_id=film.id) }}" class="btn btn-sm btn-danger">Delete</a>
            </td>
          </form>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ‚è∞ Showtime Timetable -->
  <h4>üóìÔ∏è Showtimes Grid</h4>
  <table class="table table-bordered">
    <thead class="table-dark">
      <tr>
        <th>Screen</th>
        {% for time in time_slots %}
          <th>{{ time }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for screen in screens %}
      <tr>
        <td><strong>Screen {{ screen }}</strong></td>
        {% for time in time_slots %}
          {% set key = (screen, time) %}
          <td class="cell-clickable"
              {% if not showtime_map.get(key) %}
                data-screen="{{ screen }}"
                data-time="{{ time }}"
                data-bs-toggle="modal"
                data-bs-target="#addModal"
              {% endif %}>
            {% if showtime_map.get(key) %}
              üé¨ {{ showtime_map[key].title }}
              <br>¬£{{ showtime_map[key].price }}
              <div class="btn-group mt-1">
                <a href="{{ url_for('admin.edit_showtime', showtime_id=showtime_map[key].id) }}"
                   class="btn btn-sm btn-outline-primary">Edit</a>
                <a href="{{ url_for('admin.delete_showtime', showtime_id=showtime_map[key].id) }}"
                   class="btn btn-sm btn-outline-danger">üóëÔ∏è</a>
              </div>
            {% else %}
              <span class="text-muted">‚ûï Add</span>
            {% endif %}
          </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</main>

<!-- üì¶ Modal to Add Showtimes -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="/add_showtime_from_timetable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Showtime</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="cinema_id" value="{{ cinema_id }}">
          <input type="hidden" name="screen_number" id="modal_screen">
          <input type="hidden" name="time_slot" id="modal_time">
          <input type="hidden" name="date" value="{{ selected_date }}">

          <div class="mb-3">
            <label>Film:</label>
            <select name="film_id" class="form-select" required id="modal_film_select">
              <option value="">-- Choose Film --</option>
              {% for film in films %}
                <option value="{{ film.id }}">{{ film.title }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label>Price (¬£):</label>
            <input name="price" type="number" step="0.01" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success">Add Showtime</button>
        </div>
      </div>
    </form>
  </div>
</div>

<footer class="text-center bg-dark text-white py-3 mt-auto">
  <p>¬© 2025 Horizon Cinemas. All Rights Reserved.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const modal = document.getElementById('addModal');
  modal.addEventListener('show.bs.modal', function (event) {
    const cell = event.relatedTarget;
    document.getElementById('modal_screen').value = cell.dataset.screen;
    document.getElementById('modal_time').value = cell.dataset.time;

    // Auto-fill film from dropdown
    const topFilmSelect = document.querySelector('select[name="film_id"]');
    const modalFilmSelect = document.getElementById('modal_film_select');
    if (topFilmSelect && modalFilmSelect) {
      modalFilmSelect.value = topFilmSelect.value;
    }
  });
</script>

</body>
</html>